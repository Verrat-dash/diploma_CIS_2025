---
- name: "26.9 | L1 | Ensure 'Minimum Password Age' is set to '1 or more day(s)'"
  hosts: windows
  gather_facts: yes
  vars:
    min_password_age: 1  # CIS требование: минимум 1 день

  tasks:
    # ЗАДАЧА 1: Проверяем текущее значение через secpol
    - name: "CHECK | Check current minimum password age setting"
      ansible.windows.win_shell: |
        secedit /export /cfg C:\temp_check.cfg
        $current = Get-Content C:\temp_check.cfg | Select-String "MinimumPasswordAge"
        Remove-Item C:\temp_check.cfg -Force
        
        if ($current) {
          $current_value = [regex]::Match($current, 'MinimumPasswordAge\s*=\s*(\d+)').Groups[1].Value
          Write-Output "CURRENT: $current_value"
        } else {
          Write-Output "CURRENT: NOT_SET"
        }
      register: current_check
      changed_when: false
      tags:
        - all
        - cis-windows
        - section26
        - "26.9"

    # ЗАДАЧА 2: Применяем настройку через secpol
    - name: "REMEDIATION | Configure minimum password age to 1 or more days"
      ansible.windows.win_shell: |
        # Создаем конфигурационный файл для secpol
        "[Unicode]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode
        "Unicode=yes" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "[Version]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "signature=`$CHICAGO`$" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "Revision=1" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "[System Access]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "MinimumPasswordAge={{ min_password_age }}" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        
        # Применяем политику
        secedit /configure /db C:\temp.sdb /cfg C:\temp_apply.cfg /quiet
        
        # Очищаем временные файлы
        Remove-Item C:\temp.sdb -Force -ErrorAction SilentlyContinue
        Remove-Item C:\temp_apply.cfg -Force -ErrorAction SilentlyContinue
        
        Write-Output "Applied minimum password age: 1 or more days"
      # ВЫПОЛНЯТЬ ЕСЛИ: первый запуск ИЛИ настройка не равна 1
      when: current_check.stdout is not defined or min_password_age|string not in current_check.stdout
      tags:
        - all
        - cis-windows
        - section26
        - "26.9"

    # ЗАДАЧА 3: Проверяем результат
    - name: "VERIFY | Verify minimum password age policy"
      ansible.windows.win_shell: |
        secedit /export /cfg C:\temp_verify.cfg
        $min_age = Get-Content C:\temp_verify.cfg | Select-String "MinimumPasswordAge"
        Remove-Item C:\temp_verify.cfg -Force
        
        if ($min_age -and $min_age -match "MinimumPasswordAge\s*=\s*{{ min_password_age }}") {
          Write-Output "COMPLIANT: Minimum password age is set to 1 or more days"
          exit 0
        } else {
          Write-Output "NON-COMPLIANT: Minimum password age is not set to 1 or more days"
          exit 1
        }
      register: verify_result
      changed_when: false
      failed_when: verify_result.rc != 0
      tags:
        - all
        - cis-windows
        - section26
        - "26.9"