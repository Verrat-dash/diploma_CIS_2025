---
- name: "26.4 | L1 | Ensure maximum password age is 365 or fewer days"
  hosts: windows
  gather_facts: yes
  vars:
    max_password_age: 365  # CIS требование: максимум 365 дней

  tasks:
    # ЗАДАЧА 1: Проверяем текущее значение через secpol
    - name: "CHECK | Check current maximum password age setting"
      ansible.windows.win_shell: |
        secedit /export /cfg C:\temp_check.cfg
        $current = Get-Content C:\temp_check.cfg | Select-String "MaximumPasswordAge"
        Remove-Item C:\temp_check.cfg -Force
        
        if ($current) {
          $current_value = [regex]::Match($current, 'MaximumPasswordAge\s*=\s*(\d+)').Groups[1].Value
          Write-Output "CURRENT: $current_value"
        } else {
          Write-Output "CURRENT: NOT_SET"
        }
      register: current_check
      changed_when: false
      tags:
        - all
        - cis-windows
        - section26
        - "26.4"

    # ЗАДАЧА 2: Применяем настройку через secpol (только если нужно)
    - name: "REMEDIATION | Configure maximum password age to {{ max_password_age }} days"
      ansible.windows.win_shell: |
        # Создаем конфигурационный файл для secpol
        "[Unicode]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode
        "Unicode=yes" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "[Version]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "signature=`$CHICAGO`$" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "Revision=1" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        # Секция где находятся настройки паролей
        "[System Access]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        # Устанавливаем CIS-требование: максимальный срок пароля = 365 дней
        "MaximumPasswordAge={{ max_password_age }}" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        
        # Применяем политику
        secedit /configure /db C:\temp.sdb /cfg C:\temp_apply.cfg /quiet
        
        # Очищаем временные файлы
        Remove-Item C:\temp.sdb -Force -ErrorAction SilentlyContinue
        Remove-Item C:\temp_apply.cfg -Force -ErrorAction SilentlyContinue
        
        Write-Output "Applied maximum password age: {{ max_password_age }} days"
      # ВЫПОЛНЯТЬ ЕСЛИ: первый запуск ИЛИ настройка не равна 365
      when: current_check.stdout is not defined or max_password_age|string not in current_check.stdout
      tags:
        - all
        - cis-windows
        - section26
        - "26.4"

    # ЗАДАЧА 3: Проверяем результат
    - name: "VERIFY | Verify maximum password age policy"
      ansible.windows.win_shell: |
        secedit /export /cfg C:\temp_verify.cfg
        $max_age = Get-Content C:\temp_verify.cfg | Select-String "MaximumPasswordAge"
        Remove-Item C:\temp_verify.cfg -Force
        
        if ($max_age -and $max_age -match "MaximumPasswordAge\s*=\s*{{ max_password_age }}") {
          Write-Output "COMPLIANT: Maximum password age is set to {{ max_password_age }} days"
          exit 0
        } else {
          Write-Output "NON-COMPLIANT: Maximum password age is not set to {{ max_password_age }} days"
          exit 1
        }
      register: verify_result
      changed_when: false
      failed_when: verify_result.rc != 0
      tags:
        - all
        - cis-windows
        - section26
        - "26.4"