---
- name: "26.5 | L1 | Ensure password history is set to 24 or more passwords"
  hosts: windows  # Целевые хосты - группа Windows из inventory
  gather_facts: yes  # Собираем информацию о системе (версия ОС, архитектура и т.д.)
  vars:
    password_history_size: 24  # CIS Benchmark требует минимум 24 сохраненных пароля

  tasks:
    # ЗАДАЧА 1: Проверяем текущее значение через secpol (Security Policy Editor)
    - name: "CHECK | Check current password history setting"
      ansible.windows.win_shell: |  # Выполняем PowerShell команды на Windows хосте
        # Экспортируем текущие настройки безопасности локальной политики в файл
        secedit /export /cfg C:\temp_check.cfg  # Создает файл со всеми настройками безопасности
        
        # Ищем строку с настройкой PasswordHistorySize в экспортированном файле
        # Select-String ищет совпадения по шаблону (аналог grep в Linux)
        $current = Get-Content C:\temp_check.cfg | Select-String "PasswordHistorySize"
        
        # Удаляем временный файл для очистки системы
        Remove-Item C:\temp_check.cfg -Force  # -Force гарантирует удаление даже если файл readonly
        
        # Если настройка найдена в файле
        if ($current) {
          # Используем регулярное выражение для извлечения числа из строки вида "PasswordHistorySize = 24"
          # \s* - любое количество пробелов, (\d+) - одна или больше цифр (захватываем в группу 1)
          $current_value = [regex]::Match($current, 'PasswordHistorySize\s*=\s*(\d+)').Groups[1].Value
          # Выводим в формате "CURRENT: <число>" для совместимости с условием проверки
          Write-Output "CURRENT: $current_value"  # Формат важен для работы условия when!
        } else {
          # Если настройка не найдена (не установлена в системе)
          Write-Output "CURRENT: NOT_SET"
        }
      register: current_check  # Сохраняем результат выполнения задачи (stdout, stderr, rc)
      changed_when: false  # Эта задача никогда не считается "изменившей" состояние системы
      tags:  # Метки для выборочного запуска задач
        - all           # Все задачи
        - cis-windows   # Все CIS задачи для Windows
        - section26     # Все задачи из секции 26 CIS
        - "26.5"        # Конкретно эта задача

    # ЗАДАЧА 2: Применяем настройку через secpol если требуется
    - name: "REMEDIATION | Configure password history to {{ password_history_size }}"
      ansible.windows.win_shell: |
        # Создаем конфигурационный файл в формате, который понимает утилита secedit
        
        # Заголовок файла конфигурации секьюрити политики
        "[Unicode]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode  # Начинаем новый файл
        "Unicode=yes" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append  # Добавляем строку
        
        # Секция версии (обязательная для secedit)
        "[Version]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "signature=`$CHICAGO`$" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append  # Фиксированная сигнатура
        "Revision=1" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        
        # Секция где находятся настройки доступа к системе (включая политики паролей)
        "[System Access]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        
        # Устанавливаем требуемое CIS значение - история 24 паролей
        # {{ password_history_size }} подставится из переменной (24)
        "PasswordHistorySize={{ password_history_size }}" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        
        # Применяем политику безопасности из конфигурационного файла
        # /db - временная база данных политики (создается автоматически)
        # /cfg - конфигурационный файл с настройками
        # /quiet - тихий режим (без диалоговых окон)
        secedit /configure /db C:\temp.sdb /cfg C:\temp_apply.cfg /quiet
        
        # Очищаем временные файлы чтобы не оставлять следов
        Remove-Item C:\temp.sdb -Force -ErrorAction SilentlyContinue  # Игнорируем ошибки если файла нет
        Remove-Item C:\temp_apply.cfg -Force -ErrorAction SilentlyContinue
        
        # Информационное сообщение для логов Ansible
        Write-Output "Applied password history size: {{ password_history_size }}"
      # Условие выполнения: задача выполняется если:
      # 1. Результат проверки не определен (первый запуск) ИЛИ
      # 2. Требуемое значение (24) не содержится в выводе проверки
      when: current_check.stdout is not defined or password_history_size|string not in current_check.stdout
      tags:
        - all
        - cis-windows
        - section26
        - "26.5"

    # ЗАДАЧА 3: Проверяем что настройка успешно применена
    - name: "VERIFY | Verify password history policy"
      ansible.windows.win_shell: |
        # Экспортируем текущие настройки чтобы проверить результат применения
        secedit /export /cfg C:\temp_verify.cfg
        
        # Проверяем что настройка PasswordHistorySize присутствует в файле
        $history = Get-Content C:\temp_verify.cfg | Select-String "PasswordHistorySize"
        
        # Удаляем временный файл проверки
        Remove-Item C:\temp_verify.cfg -Force
        
        # Проверяем соответствие требуемому значению (24)
        # Условие: настройка найдена И соответствует значению {{ password_history_size }}
        if ($history -and $history -match "PasswordHistorySize\s*=\s*{{ password_history_size }}") {
          # Успех - соответствует требованиям CIS Benchmark
          Write-Output "COMPLIANT: Password history is set to {{ password_history_size }}"
          exit 0   # Код возврата 0 = успех в PowerShell/Ansible
        } else {
          # Ошибка - не соответствует требованиям CIS
          Write-Output "NON-COMPLIANT: Password history is not set to {{ password_history_size }}"
          exit 1   # Код возврата 1 = ошибка
        }
      register: verify_result  # Сохраняем результат проверки
      changed_when: false  # Эта задача не меняет состояние системы
      failed_when: verify_result.rc != 0  # Задача считается неудачной если код возврата не 0
      tags:
        - all
        - cis-windows
        - section26
        - "26.5"
