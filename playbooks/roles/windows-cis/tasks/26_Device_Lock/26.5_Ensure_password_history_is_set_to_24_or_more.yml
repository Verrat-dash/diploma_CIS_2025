---
- name: "26.5 | L1 | Ensure password history is set to 24 or more passwords"
  hosts: windows
  gather_facts: yes # Собираем информацию о системе
  vars:
    password_history_size: 24

  tasks:
    # ЗАДАЧА 1: Проверяем текущее значение через secpol
    - name: "CHECK | Check current password history setting"
      ansible.windows.win_shell: |  # Выполняем PowerShell команды на Windows
        # Экспортируем текущие настройки безопасности в файл
        secedit /export /cfg C:\temp_check.cfg # Теперь в C:\temp_check.cfg лежит БОЛЬШОЙ файл со всеми настройками безопасности
        
        # Ищем строку с настройкой истории паролей в экспортированном файле
        $current = Get-Content C:\temp_check.cfg | Select-String "PasswordHistorySize"
        
        # Удаляем временный файл
        Remove-Item C:\temp_check.cfg -Force
        
        # Если настройка найдена, извлекаем числовое значение
        if ($current) {
          # Регулярное выражение для извлечения числа после "PasswordHistorySize = "
          $current_value = [regex]::Match($current, 'PasswordHistorySize\s*=\s*(\d+)').Groups[1].Value
          Write-Output "CURRENT: $current_value"  # Выводим текущее значение для отладки
        } else {
          Write-Output "CURRENT: NOT_SET"  # Если настройка не установлена
        }
      register: current_check  # Сохраняем результат в переменную
      changed_when: false
      tags:
        - all
        - cis-windows
        - section26
        - "26.5"

    # ЗАДАЧА 2: Применяем настройку через secpol
    - name: "REMEDIATION | Configure password history to {{ password_history_size }}"
      ansible.windows.win_shell: |
        # Создаем конфигурационный файл для secpol
        "[Unicode]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode
        "Unicode=yes" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "[Version]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "signature=`$CHICAGO`$" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "Revision=1" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        
        # Секция с настройками безопасности
        "[System Access]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        # Устанавливаем требуемое CIS значение - 24 сохраненных пароля
        "PasswordHistorySize={{ password_history_size }}" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        
        # Применяем политику безопасности из конфигурационного файла
        # /db - временная база данных, /cfg - конфигурационный файл, /quiet - тихий режим
        secedit /configure /db C:\temp.sdb /cfg C:\temp_apply.cfg /quiet
        
        # Очищаем временные файлы
        Remove-Item C:\temp.sdb -Force -ErrorAction SilentlyContinue
        Remove-Item C:\temp_apply.cfg -Force -ErrorAction SilentlyContinue
        
        Write-Output "Applied password history size: {{ password_history_size }}"
      # Условие выполнения: если настройка не проверена или текущее значение не соответствует требуемому
      when: current_check.stdout is not defined or password_history_size|string not in current_check.stdout
      tags:
        - all
        - cis-windows
        - section26
        - "26.5"

    # ЗАДАЧА 3: Проверяем результат
    - name: "VERIFY | Verify password history policy"
      ansible.windows.win_shell: |
        # Экспортируем настройки для проверки
        secedit /export /cfg C:\temp_verify.cfg
        # Проверяем что настройка применена корректно
        $history = Get-Content C:\temp_verify.cfg | Select-String "PasswordHistorySize"
        Remove-Item C:\temp_verify.cfg -Force
        
        # Проверяем соответствие требуемому значению
        if ($history -and $history -match "PasswordHistorySize\s*=\s*{{ password_history_size }}") {
          Write-Output "COMPLIANT: Password history is set to {{ password_history_size }}"
          exit 0   # Успех - соответствует требованиям CIS
        } else {
          Write-Output "NON-COMPLIANT: Password history is not set to {{ password_history_size }}"
          exit 1   # Ошибка - не соответствует требованиям CIS
        }
      register: verify_result
      changed_when: false
      failed_when: verify_result.rc != 0   # Задача падает если проверка не пройдена (exit code != 0)
      tags:
        - all
        - cis-windows
        - section26
        - "26.5"