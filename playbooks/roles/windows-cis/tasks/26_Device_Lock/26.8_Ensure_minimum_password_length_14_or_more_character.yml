---
- name: "26.8 | L1 | Ensure 'Minimum Password Length' is set to '14 or more character(s)'"
  hosts: windows
  gather_facts: yes
  vars:
    min_password_length: 14  # CIS требование: минимум 14 символов

  tasks:
    # ЗАДАЧА 1: Проверяем текущее значение через secpol
    - name: "CHECK | Check current minimum password length setting"
      ansible.windows.win_shell: |
        secedit /export /cfg C:\temp_check.cfg
        $current = Get-Content C:\temp_check.cfg | Select-String "MinimumPasswordLength"
        Remove-Item C:\temp_check.cfg -Force
        
        if ($current) {
          $current_value = [regex]::Match($current, 'MinimumPasswordLength\s*=\s*(\d+)').Groups[1].Value
          Write-Output "CURRENT: $current_value"
        } else {
          Write-Output "CURRENT: NOT_SET"
        }
      register: current_check
      changed_when: false
      tags:
        - all
        - cis-windows
        - section26
        - "26.8"

    # ЗАДАЧА 2: Применяем настройку через secpol
    - name: "REMEDIATION | Configure minimum password length to 14 or more characters"
      ansible.windows.win_shell: |
        # Создаем конфигурационный файл для secpol
        "[Unicode]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode
        "Unicode=yes" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "[Version]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "signature=`$CHICAGO`$" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "Revision=1" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "[System Access]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "MinimumPasswordLength={{ min_password_length }}" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        
        # Применяем политику
        secedit /configure /db C:\temp.sdb /cfg C:\temp_apply.cfg /quiet
        
        # Очищаем временные файлы
        Remove-Item C:\temp.sdb -Force -ErrorAction SilentlyContinue
        Remove-Item C:\temp_apply.cfg -Force -ErrorAction SilentlyContinue
        
        Write-Output "Applied minimum password length: 14 or more characters"
      # ВЫПОЛНЯТЬ ЕСЛИ: первый запуск ИЛИ настройка не равна 14
      when: current_check.stdout is not defined or min_password_length|string not in current_check.stdout
      tags:
        - all
        - cis-windows
        - section26
        - "26.8"

    # ЗАДАЧА 3: Проверяем результат
    - name: "VERIFY | Verify minimum password length policy"
      ansible.windows.win_shell: |
        secedit /export /cfg C:\temp_verify.cfg
        $min_length = Get-Content C:\temp_verify.cfg | Select-String "MinimumPasswordLength"
        Remove-Item C:\temp_verify.cfg -Force
        
        if ($min_length -and $min_length -match "MinimumPasswordLength\s*=\s*{{ min_password_length }}") {
          Write-Output "COMPLIANT: Minimum password length is set to 14 or more characters"
          exit 0
        } else {
          Write-Output "NON-COMPLIANT: Minimum password length is not set to 14 or more characters"
          exit 1
        }
      register: verify_result
      changed_when: false
      failed_when: verify_result.rc != 0
      tags:
        - all
        - cis-windows
        - section26
        - "26.8"