---
- name: "26.6 | L1 | Ensure 'Device Password Enabled: Max Device Password Failed Attempts' is set to '5 or fewer failed attempt(s), but not 0'"
  hosts: windows
  gather_facts: yes
  vars:
    max_failed_attempts: 5  # CIS требование: 5 или менее неудачных попыток, но не 0

  tasks:
    # ЗАДАЧА 1: Проверяем текущее значение через secpol
    - name: "CHECK | Check current max device password failed attempts setting"
      ansible.windows.win_shell: |
        secedit /export /cfg C:\temp_check.cfg
        $current = Get-Content C:\temp_check.cfg | Select-String "LockoutBadCount"
        Remove-Item C:\temp_check.cfg -Force
        
        if ($current) {
          $current_value = [regex]::Match($current, 'LockoutBadCount\s*=\s*(\d+)').Groups[1].Value
          Write-Output "CURRENT: $current_value"
        } else {
          Write-Output "CURRENT: NOT_SET"
        }
      register: current_check
      changed_when: false
      tags:
        - all
        - cis-windows
        - section26
        - "26.6"

    # ЗАДАЧА 2: Применяем настройку через secpol
    - name: "REMEDIATION | Configure max device password failed attempts to 5 or fewer"
      ansible.windows.win_shell: |
        # Создаем конфигурационный файл для secpol
        "[Unicode]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode
        "Unicode=yes" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "[Version]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "signature=`$CHICAGO`$" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "Revision=1" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "[System Access]" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        "LockoutBadCount={{ max_failed_attempts }}" | Out-File -FilePath C:\temp_apply.cfg -Encoding Unicode -Append
        
        # Применяем политику
        secedit /configure /db C:\temp.sdb /cfg C:\temp_apply.cfg /quiet
        
        # Очищаем временные файлы
        Remove-Item C:\temp.sdb -Force -ErrorAction SilentlyContinue
        Remove-Item C:\temp_apply.cfg -Force -ErrorAction SilentlyContinue
        
        Write-Output "Applied max device password failed attempts: 5 or fewer"
      # ВЫПОЛНЯТЬ ЕСЛИ: первый запуск ИЛИ настройка не равна 5
      when: current_check.stdout is not defined or max_failed_attempts|string not in current_check.stdout
      tags:
        - all
        - cis-windows
        - section26
        - "26.6"

    # ЗАДАЧА 3: Проверяем результат
    - name: "VERIFY | Verify max device password failed attempts policy"
      ansible.windows.win_shell: |
        secedit /export /cfg C:\temp_verify.cfg
        $failed_attempts = Get-Content C:\temp_verify.cfg | Select-String "LockoutBadCount"
        Remove-Item C:\temp_verify.cfg -Force
        
        if ($failed_attempts -and $failed_attempts -match "LockoutBadCount\s*=\s*{{ max_failed_attempts }}") {
          Write-Output "COMPLIANT: Max device password failed attempts is set to 5 or fewer"
          exit 0
        } else {
          Write-Output "NON-COMPLIANT: Max device password failed attempts is not set to 5 or fewer"
          exit 1
        }
      register: verify_result
      changed_when: false
      failed_when: verify_result.rc != 0
      tags:
        - all
        - cis-windows
        - section26
        - "26.6"