---
- name: "4.11.27.1 | L1 | Ensure 'Block all Microsoft consumer accounts' is set to 'Enabled'"
  hosts: windows
  gather_facts: yes
  vars:
    microsoft_accounts_policy: 3  # CIS требование: 3 = Блокировать все учетные записи Microsoft
    # 0 = Разрешить учетные записи Microsoft, 1 = Блокировать предприятиям настраивать эту политику
  tasks:
    # ЗАДАЧА 1: Проверяем текущее значение в реестре
    - name: "CHECK | Check current 'Block Microsoft consumer accounts' setting"
      ansible.windows.win_reg_stat:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
        name: NoConnectedUser # Имя параметра реестра который проверяем
      register: registry_check
      tags:
        - all
        - cis-windows
        - section4
        - "4.11.27.1"

    # ЗАДАЧА 2: Применяем настройку через реестр
    - name: "REMEDIATION | Configure Microsoft accounts policy to block all consumer accounts"
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
        name: NoConnectedUser
        data: "{{ microsoft_accounts_policy }}"
        type: dword
      # ВЫПОЛНЯТЬ ЕСЛИ: настройка не существует ИЛИ значение не равно требуемому
      when: registry_check.exists == false or (registry_check.exists == true and registry_check.value != microsoft_accounts_policy)
      tags:
        - all
        - cis-windows
        - section4
        - "4.11.27.1"

    # ЗАДАЧА 3: Проверяем результат
    - name: "VERIFY | Verify Microsoft accounts policy"
      ansible.windows.win_reg_stat:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
        name: NoConnectedUser
      register: verify_result
      changed_when: false
      failed_when: verify_result.exists == false or (verify_result.exists == true and verify_result.value != microsoft_accounts_policy)
      tags:
        - all
        - cis-windows
        - section4
        - "4.11.27.1"