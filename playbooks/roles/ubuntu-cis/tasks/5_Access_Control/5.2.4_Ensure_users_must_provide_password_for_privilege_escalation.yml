---
- name: "5.2.4 | L2 | Ensure users must provide password for privilege escalation"
  hosts: ubuntu
  become: yes
  tasks:

    # ЗАДАЧА 1: Проверяем текущие настройки sudo для группы admin
    - name: "Check current sudo configuration for admin group"
      ansible.builtin.shell: |
        if grep -q '^%admin\s\+ALL=(ALL:ALL)\s\+ALL' /etc/sudoers; then
          echo "ADMIN_CORRECT"
        elif grep -q '^%admin' /etc/sudoers; then
          admin_line=$(grep '^%admin' /etc/sudoers)
          echo "ADMIN_WRONG:$admin_line"
        else
          echo "ADMIN_NOT_FOUND"
        fi
      register: admin_check
      changed_when: false
      failed_when: false
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 2: Проверяем текущие настройки sudo для группы sudo
    - name: "Check current sudo configuration for sudo group"
      ansible.builtin.shell: |
        if grep -q '^%sudo\s\+ALL=(ALL:ALL)\s\+ALL' /etc/sudoers; then
          echo "SUDO_CORRECT"
        elif grep -q '^%sudo' /etc/sudoers; then
          sudo_line=$(grep '^%sudo' /etc/sudoers)
          echo "SUDO_WRONG:$sudo_line"
        else
          echo "SUDO_NOT_FOUND"
        fi
      register: sudo_group_check
      changed_when: false
      failed_when: false
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 3: Настраиваем правильные права для группы admin (только если настройка неправильная)
    - name: "Configure sudo for admin group"
      ansible.builtin.replace:
        path: /etc/sudoers
        regexp: '^%admin\s+.*'
        replace: '%admin  ALL=(ALL:ALL) ALL'
        validate: 'visudo -cf %s'
      when: admin_check.stdout == "ADMIN_WRONG"
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 4: Добавляем настройку для группы admin (только если её нет)
    - name: "Add admin group configuration if missing"
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        line: '%admin  ALL=(ALL:ALL) ALL'
        insertafter: '# User privilege specification'
        validate: 'visudo -cf %s'
      when: admin_check.stdout == "ADMIN_NOT_FOUND"
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 5: Настраиваем правильные права для группы sudo (только если настройка неправильная)
    - name: "Configure sudo for sudo group"
      ansible.builtin.replace:
        path: /etc/sudoers
        regexp: '^%sudo\s+.*'
        replace: '%sudo   ALL=(ALL:ALL) ALL'
        validate: 'visudo -cf %s'
      when: sudo_group_check.stdout == "SUDO_WRONG"
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 6: Добавляем настройку для группы sudo (только если её нет)
    - name: "Add sudo group configuration if missing"
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        line: '%sudo   ALL=(ALL:ALL) ALL'
        insertafter: '# User privilege specification'
        validate: 'visudo -cf %s'
      when: sudo_group_check.stdout == "SUDO_NOT_FOUND"
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 7: Проверяем что нет опасных настроек NOPASSWD (для всех пользователей и групп)
    - name: "Check for dangerous NOPASSWD settings"
      ansible.builtin.shell: |
        # Ищем NOPASSWD для любых пользователей и групп
        if grep -r 'NOPASSWD' /etc/sudoers /etc/sudoers.d/ 2>/dev/null | grep -v '^#' | grep -q 'NOPASSWD'; then
          echo "DANGEROUS_NOPASSWD_FOUND"
        else
          echo "NO_DANGEROUS_NOPASSWD"
        fi
      register: nopasswd_check
      changed_when: false
      failed_when: false
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 8: Убираем опасные настройки NOPASSWD из основного файла sudoers
    - name: "Remove dangerous NOPASSWD settings from sudoers"
      ansible.builtin.replace:
        path: /etc/sudoers
        regexp: '^[^#].*NOPASSWD.*'
        replace: ''
        validate: 'visudo -cf %s'
      when: "'DANGEROUS_NOPASSWD_FOUND' in nopasswd_check.stdout"
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 9: УДАЛЯЕМ ВСЕ ФАЙЛЫ с NOPASSWD настройками в sudoers.d
    - name: "Remove dangerous NOPASSWD files from sudoers.d"
      ansible.builtin.shell: |
        # Находим и удаляем файлы содержащие NOPASSWD (кроме README)
        find /etc/sudoers.d/ -type f ! -name 'README' -exec grep -l 'NOPASSWD' {} \; | xargs -r rm -f
      when: "'DANGEROUS_NOPASSWD_FOUND' in nopasswd_check.stdout"
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 10: Проверяем права доступа файлов в sudoers.d
    - name: "Check sudoers.d files permissions"
      ansible.builtin.shell: |
        # Проверяем есть ли файлы с неправильными правами
        bad_files=$(find /etc/sudoers.d/ -type f -not -perm 0440 2>/dev/null | wc -l)
        if [ $bad_files -gt 0 ]; then
          echo "BAD_PERMISSIONS_FOUND"
        else
          echo "PERMISSIONS_CORRECT"
        fi
      register: permissions_check
      changed_when: false
      failed_when: false
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 11: Исправляем права доступа директории sudoers.d (только если нужно)
    - name: "Fix sudoers.d directory permissions"
      ansible.builtin.file:
        path: /etc/sudoers.d
        state: directory
        mode: '0750'
        owner: root
        group: root
      when: "'BAD_PERMISSIONS_FOUND' in permissions_check.stdout"
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 12: Исправляем права доступа файлов в sudoers.d (только если нужно)
    - name: "Fix sudoers.d files permissions"
      ansible.builtin.shell: |
        find /etc/sudoers.d/ -type f -exec chmod 0440 {} \;
        find /etc/sudoers.d/ -type f -exec chown root:root {} \;
      when: "'BAD_PERMISSIONS_FOUND' in permissions_check.stdout"
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 13: Проверяем синтаксис sudoers файла (всегда проверяем)
    - name: "Validate sudoers syntax"
      ansible.builtin.shell: |
        visudo -c
      register: sudoers_syntax_check
      changed_when: false
      failed_when: sudoers_syntax_check.rc != 0
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 14: Проверяем конечную конфигурацию (всегда проверяем)
    - name: "Verify sudo configuration"
      ansible.builtin.shell: |
        admin_ok=$(grep -q '^%admin\s\+ALL=(ALL:ALL)\s\+ALL' /etc/sudoers && echo "YES" || echo "NO")
        sudo_ok=$(grep -q '^%sudo\s\+ALL=(ALL:ALL)\s\+ALL' /etc/sudoers && echo "YES" || echo "NO")
        nopasswd_ok=$([ -z "$(grep -r '^%\(admin\|sudo\)\s\+.*NOPASSWD' /etc/sudoers /etc/sudoers.d/ 2>/dev/null)" ] && echo "YES" || echo "NO")
        
        if [ "$admin_ok" = "YES" ] && [ "$sudo_ok" = "YES" ] && [ "$nopasswd_ok" = "YES" ]; then
          echo "PERFECT"
        else
          echo "ERROR: admin=$admin_ok, sudo=$sudo_ok, nopasswd=$nopasswd_ok"
          exit 1
        fi
      register: sudo_verify
      changed_when: false
      failed_when: "'PERFECT' not in sudo_verify.stdout"
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4

    # ЗАДАЧА 15: Показываем итоговую конфигурацию (всегда показываем)
    - name: "Show final sudo configuration"
      ansible.builtin.shell: |
        echo "=== FINAL SUDO CONFIGURATION ==="
        grep '^%admin' /etc/sudoers 2>/dev/null || echo "admin: NOT FOUND"
        grep '^%sudo' /etc/sudoers 2>/dev/null || echo "sudo: NOT FOUND"
        echo "=== SUDOERS.D FILES ==="
        find /etc/sudoers.d/ -type f -exec echo "File: {}" \; -exec grep '^%\(admin\|sudo\)' {} \; 2>/dev/null
      changed_when: false
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.2.4