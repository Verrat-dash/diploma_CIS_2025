---
- name: "5.4.1.1 | L1 | Ensure password expiration is configured"
  hosts: ubuntu
  become: yes
  vars:
    password_max_days: 365
  tasks:

    - name: "Check current password maximum age in login.defs" # ЗАДАЧА 1: Проверка текущих настроек в файле login.defs
      ansible.builtin.command: grep '^PASS_MAX_DAYS' /etc/login.defs
      register: current_login_defs # Сохранить результат команды в переменную current_login_defs
      changed_when: false
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.4.1.1

    - name: "Configure password maximum age in login.defs" # ЗАДАЧА 2: Настройка максимального срока паролей для новых пользователей
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^PASS_MAX_DAYS\s+\d+'
        line: 'PASS_MAX_DAYS {{ password_max_days }}'
      when: current_login_defs.stdout != "PASS_MAX_DAYS " ~ password_max_days # Условие выполнения: выполнять только если текущая строка НЕ совпадает с нужной
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.4.1.1

    - name: "Check current user password policies" # ЗАДАЧА 3: Проверка текущих настроек ВСЕХ пользователей
      # Выполнить shell-скрипт для проверки всех пользователей:1. Цикл по всем обычным пользователям (UID >= 1000, кроме nobody), 2. Получить текущее значение максимальных дней для пароля пользователя, 3.Если значение не совпадает с нужным - добавить пользователя в список
      ansible.builtin.shell: |
        for user in $(awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd); do
          current_days=$(chage -l "$user" 2>/dev/null | grep "Maximum" | awk -F: '{print $2}' | tr -d ' ' || echo "0")
          if [ "$current_days" -ne "{{ password_max_days }}" ]; then
            echo "$user"
          fi
        done
      register: users_to_update # Сохранить результат после выполнения shell-скрипта
      changed_when: false
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.4.1.1

    - name: "Set password max days only for users that need update"  # ЗАДАЧА 4: Обновление настроек только для нужных пользователей
      # Shell-скрипт: 1.Цикл по всем пользователям из списка, 2.Установить максимальный срок пароля для пользователя
      ansible.builtin.shell: |
        for user in {{ users_to_update.stdout_lines | join(" ") }}; do
          chage --maxdays {{ password_max_days }} "$user"
        done
      when: users_to_update.stdout != "" # Условие: выполнять только если есть пользователи для обновления
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.4.1.1

    - name: "Verify ALL user password policies" # ЗАДАЧА 5: Финальная проверка ВСЕХ пользователей
      # Shell-скрипт: 1.Цикл по всем обычным пользователям, 2.Получить текущее значение максимальных дней, 3.Если значение не совпадает - вывести ошибку и завершиться с кодом 1, 4.Если все пользователи правильные - вывести сообщение об успехе
      ansible.builtin.shell: |
        for user in $(awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd); do
          current_days=$(chage -l "$user" | grep "Maximum" | awk -F: '{print $2}' | tr -d ' ')
          if [ "$current_days" -ne "{{ password_max_days }}" ]; then
            echo "ERROR: User $user has $current_days days"
            exit 1
          fi
        done
        echo "ALL_USERS_CORRECT"
      register: all_users_verify # Сохранить результат проверки
      changed_when: false
      failed_when: "'ALL_USERS_CORRECT' not in all_users_verify.stdout" # Условие провала: если в выводе нет "ALL_USERS_CORRECT"
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.4.1.1