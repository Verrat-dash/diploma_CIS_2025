---
- name: "5.3.3.1.2 | L1 | Ensure password unlock time is configured"
  hosts: ubuntu
  become: yes
  vars:
    faillock_unlock_time: 900  # CIS Benchmark: разблокировка через 900 секунд (15 минут)
  tasks:

    # ЗАДАЧА 1: Проверяем существование файла faillock.conf
    - name: "Check if faillock.conf exists"
      ansible.builtin.stat:
        path: /etc/security/faillock.conf
      register: faillock_file
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.1.2

    # ЗАДАЧА 2: Создаем файл faillock.conf если он не существует
    - name: "Create faillock.conf if missing"
      ansible.builtin.copy:
        dest: /etc/security/faillock.conf
        content: |
          # This file is managed by Ansible - CIS Ubuntu Benchmark
          # Configuration for account lockout on failed password attempts
          unlock_time = {{ faillock_unlock_time }}
        owner: root # Владелец файла - root
        group: root # Группа файла - root
        mode: 0644  # Права доступа: владелец - чтение/запись, остальные - только чтение
      when: not faillock_file.stat.exists # Условие: выполнять только если файл не существует
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.1.2

    # ЗАДАЧА 3: Настраиваем параметр unlock_time 
    - name: "Configure unlock_time parameter in faillock.conf"
      ansible.builtin.lineinfile:
        path: /etc/security/faillock.conf
        regexp: '^\s*unlock_time\s*=\s*\d+'
        line: 'unlock_time = {{ faillock_unlock_time }}'
        insertafter: 'EOF' # Вставлять в конец файла если строка не найдена
        create: yes
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.1.2

    # ЗАДАЧА 4: Удаляем закомментированные параметры unlock_time если есть
    - name: "Remove commented unlock_time parameters"
      ansible.builtin.replace:
        path: /etc/security/faillock.conf
        regexp: '^\s*#\s*unlock_time\s*=\s*\d+' # Ищем закомментированные строки unlock_time
        replace: '' # Заменяем на пустую строку (удаляем)
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.1.2
    # ЗАДАЧА 5: Проверяем конечную конфигурацию для unlock_time
    - name: "Verify unlock_time configuration"
      ansible.builtin.shell: |
        # Проверяем что параметр unlock_time установлен правильно
        unlock_count=$(grep -E '^\s*unlock_time\s*=\s*{{ faillock_unlock_time }}\s*$' /etc/security/faillock.conf | wc -l)
        wrong_unlock_count=$(grep -E '^\s*unlock_time\s*=\s*[0-9]+' /etc/security/faillock.conf | grep -v 'unlock_time = {{ faillock_unlock_time }}' | wc -l)
        
        if [ "$unlock_count" -eq 1 ] && [ "$wrong_unlock_count" -eq 0 ]; then
          echo "PERFECT"
        else
          echo "ERROR: correct unlock_time found=$unlock_count, wrong unlock_time found=$wrong_unlock_count"
          exit 1
        fi
      register: unlock_verify
      changed_when: false
      failed_when: "'PERFECT' not in unlock_verify.stdout"
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.1.2