---
- name: "5.3.3.1.1 | L1 | Ensure password failed attempts lockout is configured"
  hosts: ubuntu
  become: yes
  vars:
    faillock_deny: 5  # CIS Benchmark: блокировка после 5 неудачных попыток
  tasks:

    # ЗАДАЧА 1: Проверяем существование файла faillock.conf
    - name: "Check if faillock.conf exists"
      ansible.builtin.stat:
        path: /etc/security/faillock.conf # Проверяем наличие конфигурационного файла блокировки
      register: faillock_file # Регистрируем результат проверки файла
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.1.1
        
    # ЗАДАЧА 2: Создаем файл faillock.conf если он не существует
    - name: "Create faillock.conf if missing"
      ansible.builtin.copy:
        dest: /etc/security/faillock.conf # Путь к целевому файлу
        # Содержимое файла при создании
        content: |
          # This file is managed by Ansible - CIS Ubuntu Benchmark
          # Configuration for account lockout on failed password attempts
          deny = {{ faillock_deny }}
        owner: root # Владелец файла - root
        group: root # Группа файла - root
        mode: 0644 # Права доступа: владелец - чтение/запись, остальные - только чтение
      when: not faillock_file.stat.exists # Условие: выполнять только если файл не существует
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.1.1

    # ЗАДАЧА 3: Настройка параметра deny в существующем файле
    - name: "Configure deny parameter in faillock.conf"
      ansible.builtin.lineinfile:
        path: /etc/security/faillock.conf
        regexp: '^\s*deny\s*=\s*\d+'
        line: 'deny = {{ faillock_deny }}'
        insertafter: 'EOF' # Вставлять в конец файла если строка не найдена
        create: yes
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.1.1

    # ЗАДАЧА 4: Удаляем закомментированные параметры deny 
    - name: "Remove commented deny parameters"
      ansible.builtin.replace:
        path: /etc/security/faillock.conf 
        regexp: '^\s*#\s*deny\s*=\s*\d+' # Ищем закомментированные строки deny
        replace: '' # Заменяем на пустую строку (удаляем)
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.1.1

    # ЗАДАЧА 5: Проверяем конечную конфигурацию для deny
    - name: "Verify deny configuration"
      ansible.builtin.shell: |
        # Проверяем что параметр deny установлен правильно
        deny_count=$(grep -E '^\s*deny\s*=\s*{{ faillock_deny }}\s*$' /etc/security/faillock.conf | wc -l)
        wrong_deny_count=$(grep -E '^\s*deny\s*=\s*[0-9]+' /etc/security/faillock.conf | grep -v 'deny = {{ faillock_deny }}' | wc -l)
        
        if [ "$deny_count" -eq 1 ] && [ "$wrong_deny_count" -eq 0 ]; then
          echo "PERFECT"
        else
          echo "ERROR: correct deny found=$deny_count, wrong deny found=$wrong_deny_count"
          exit 1
        fi
      register: deny_verify
      changed_when: false
      failed_when: "'PERFECT' not in deny_verify.stdout"
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.1.1