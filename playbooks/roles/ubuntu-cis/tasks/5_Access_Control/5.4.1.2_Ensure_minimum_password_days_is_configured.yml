---
- name: "5.4.1.2 | L2 | Ensure minimum password age is configured"
  hosts: ubuntu
  become: yes
  vars:
    password_min_days: 7
  tasks:

    - name: "Check current password minimum age in login.defs" # ЗАДАЧА 1: Проверка текущих настроек минимального срока пароля
      ansible.builtin.command: grep '^PASS_MIN_DAYS' /etc/login.defs
      register: current_login_defs
      changed_when: false
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.4.1.2

    - name: "Configure password minimum age in login.defs" # ЗАДАЧА 2: Настройка минимального срока паролей для новых пользователей
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^PASS_MIN_DAYS\s+\d+' # Искать строку: PASS_MIN_DAYS + пробелы + цифры
        line: 'PASS_MIN_DAYS {{ password_min_days }}' # Заменить на: PASS_MIN_DAYS + значение переменной
      when: current_login_defs.stdout != "PASS_MIN_DAYS " ~ password_min_days # Условие: выполнять только если текущее значение не совпадает с нужным
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.4.1.2

    - name: "Check current user minimum password age policies" # ЗАДАЧА 3: Проверка минимального срока пароля у существующих пользователей
      ansible.builtin.shell: |
        for user in $(awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd); do
          current_days=$(chage -l "$user" 2>/dev/null | grep "Minimum" | awk -F: '{print $2}' | tr -d ' ' || echo "0")
          if [ "$current_days" -ne "{{ password_min_days }}" ]; then
            echo "$user"
          fi
        done
      register: users_to_update
      changed_when: false
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.4.1.2

    - name: "Set password min days only for users that need update" # ЗАДАЧА 4: Обновление минимального срока пароля для нужных пользователей
      ansible.builtin.shell: |
        for user in {{ users_to_update.stdout_lines | join(" ") }}; do
          chage --mindays {{ password_min_days }} "$user"
        done
      when: users_to_update.stdout != "" # Условие: выполнять только если есть пользователи для обновления
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.4.1.2

    - name: "Verify ALL user minimum password age policies" # ЗАДАЧА 5: Проверка всех пользователей
      ansible.builtin.shell: |
        for user in $(awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd); do
          current_days=$(chage -l "$user" | grep "Minimum" | awk -F: '{print $2}' | tr -d ' ')
          if [ "$current_days" -ne "{{ password_min_days }}" ]; then
            echo "ERROR: User $user has $current_days min days"
            exit 1
          fi
        done
        echo "ALL_USERS_CORRECT"
      register: all_users_verify
      changed_when: false
      failed_when: "'ALL_USERS_CORRECT' not in all_users_verify.stdout" # Условие провала: если в выводе нет "ALL_USERS_CORRECT"
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.4.1.2