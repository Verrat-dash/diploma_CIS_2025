---
- name: "5.3.3.2.2 | L1 | Ensure minimum password length is configured"
  hosts: ubuntu
  become: yes
  vars:
    password_min_length: 14
  tasks:

    # ЗАДАЧА 1: Проверяем текущее состояние конфигурации
    - name: "Check current minlen configuration"
      ansible.builtin.shell: |
        line=$(grep '^password.*pam_unix.so' /etc/pam.d/common-password)
        # Считаем общее количество minlen параметров
        total_minlen=$(echo "$line" | grep -o 'minlen=[0-9]\+' | wc -l)
        # Проверяем есть ли правильный minlen
        if echo "$line" | grep -q "minlen={{ password_min_length }}"; then
          correct_minlen=1
        else
          correct_minlen=0
        fi
        echo "total:$total_minlen,correct:$correct_minlen"
      register: config_check
      changed_when: false
      failed_when: false
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.2.2

    # ЗАДАЧА 2: Удаляем ВСЕ существующие minlen параметры 
    - name: "Remove ALL existing minlen parameters"
      ansible.builtin.replace:
        path: /etc/pam.d/common-password
        regexp: '(\s)minlen=\d+'
        replace: '\1'
     # Условие выполняется если: 1.Не ровно один minlen ВООБЩЕ, 2.ИЛИ нет правильного minlen
      when: >
        (config_check.stdout.split(',')[0].split(':')[1] | int != 1) or  
        (config_check.stdout.split(',')[1].split(':')[1] | int != 1)     
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.2.2

    # ЗАДАЧА 3: Добавляем один правильный minlen параметр в конец строки
    - name: "Add correct minlen parameter"
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-password
        regexp: '^(password\s+\[success=1 default=ignore\]\s+pam_unix\.so\s+.*)$' # Ищем всю строку pam_unix
        line: '\1 minlen={{ password_min_length }}' # Заменяем на исходную строку + правильный minlen в конце
        backrefs: yes
      when: >
        (config_check.stdout.split(',')[0].split(':')[1] | int != 1) or
        (config_check.stdout.split(',')[1].split(':')[1] | int != 1)
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.2.2

    # ЗАДАЧА 4: Проверка конечной конфигурации
    - name: "Verify minimum password length configuration"
      ansible.builtin.shell: |
        # Получаем текущую строку с настройками pam_unix.so
        line=$(grep '^password.*pam_unix.so' /etc/pam.d/common-password)
        # Подсчитываем общее количество параметров minlen
        minlen_count=$(echo "$line" | grep -o 'minlen=[0-9]\+' | wc -l)
        # Проверяем что есть ровно один параметр minlen и он имеет правильное значение
        if [ "$minlen_count" -eq 1 ] && echo "$line" | grep -q "minlen={{ password_min_length }}"; then
          echo "PERFECT"
        else
          echo "ERROR: $minlen_count minlen parameters found, expected minlen={{ password_min_length }}"
          echo "Current line: $line"
          exit 1
        fi
      register: minlen_verify
      changed_when: false
      failed_when: "'PERFECT' not in minlen_verify.stdout"
      tags: 
        - all
        - cis-ubuntu
        - section5

        - 5.3.3.2.2
