---
- name: "5.3.3.3.1 | L1 | Ensure password history remember is configured"
  hosts: ubuntu
  become: yes
  vars:
    remember_count: 24
  tasks:

    # ЗАДАЧА 1: Подсчет всех строк pam_pwhistory в файле PAM
    - name: "Count ALL pam_pwhistory lines"
      ansible.builtin.shell: |
        # Ищем все упоминания pam_pwhistory.so и считаем количество
        # Если строк нет - выводим 0 чтобы избежать ошибки Ansible
        grep -c 'pam_pwhistory.so' /etc/pam.d/common-password || echo "0"
      register: total_count
      changed_when: false
      failed_when: false
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.3.1

    # ЗАДАЧА 2: Подсчет строк с ТОЧНЫМ соответствием требуемому формату
    - name: "Count CORRECT pam_pwhistory lines"
      ansible.builtin.shell: |
        # Проверяем строгое соответствие формату: начало строки, пробелы, точные параметры
        # Это отлавливает случаи с дублированными параметрами (два remember)
        grep -c '^password[[:space:]]\+requisite[[:space:]]\+pam_pwhistory.so remember={{ remember_count }} use_authtok' /etc/pam.d/common-password || echo "0"
      register: correct_count
      changed_when: false
      failed_when: false
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.3.1

    # ЗАДАЧА 3: Удаление всех строк pam_pwhistory при некорректной конфигурации
    - name: "Remove ALL pam_pwhistory lines if not exactly one correct line"
      ansible.builtin.replace:
        path: /etc/pam.d/common-password
        regexp: '^.*pam_pwhistory\.so.*\n?'  # Регулярка для поиска всех строк с pam_pwhistory
        replace: ''  # Удаляем найденные строки
      when: total_count.stdout != "1" or correct_count.stdout != "1"  # Условие: не ровно одна правильная строка
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.3.1

    # ЗАДАЧА 4: Создание корректной строки pam_pwhistory после очистки
    - name: "Configure password history with pam_pwhistory"
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-password
        line: 'password	requisite		pam_pwhistory.so remember={{ remember_count }} use_authtok'  # Требуемая CIS строка
        insertafter: '^password.*pam_unix\.so'  # Вставляем после pam_unix для правильного порядка PAM
      when: total_count.stdout != "1" or correct_count.stdout != "1"  # Только если конфигурация была некорректной
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.3.1

    # ЗАДАЧА 5: Финальная проверка корректности примененной конфигурации
    - name: "Verify password history configuration"
      ansible.builtin.shell: |
        # Двойная проверка: должно быть ровно одна строка и она должна быть правильной
        total=$(grep -c 'pam_pwhistory.so' /etc/pam.d/common-password)
        correct=$(grep -c '^password[[:space:]]\+requisite[[:space:]]\+pam_pwhistory.so remember={{ remember_count }} use_authtok' /etc/pam.d/common-password)
        if [ "$total" -eq 1 ] && [ "$correct" -eq 1 ]; then
          echo "PERFECT"
        else
          echo "ERROR: total=$total, correct=$correct"
          exit 1
        fi
      register: pam_verify
      changed_when: false
      failed_when: "'PERFECT' not in pam_verify.stdout"  # Падаем если не видим PERFECT
      tags: 
        - all
        - cis-ubuntu
        - section5
        - 5.3.3.3.1